# Требования к продукту: Социальный вишлист

Документ описывает функциональные и технические требования к приложению вишлистов с шарингом, резервацией подарков и сборами на дорогие подарки.

---

## 1. Визия продукта

**Суть:** Пользователь создаёт списки желаний (день рождения, Новый год, свадьба и т.д.), добавляет товары с названием, ссылкой, ценой и картинкой. Делится списком с друзьями по ссылке. Друзья видят вишлист и могут зарезервировать подарок, чтобы не повторяться. Создатель списка **не видит**, кто что зарезервировал — сюрприз сохраняется.

Если подарок дорогой, несколько друзей могут скинуться. Каждый отмечает свой вклад, прогресс-бар показывает, сколько собрано. Владелец вишлиста **не видит**, кто сколько скинул.

Изменения (резервация, вклад) отображаются у всех **мгновенно**, без перезагрузки страницы. Реалтайм обязателен.

---

## 2. Роли и сценарии

| Роль | Описание |
|------|----------|
| **Владелец вишлиста** | Создал список, добавляет/редактирует товары, делится ссылкой. Не видит резервации и вклады по именам. |
| **Гость по ссылке** | Открыл публичную ссылку. Может просматривать вишлист, резервировать подарки и вносить вклады. Регистрация для просмотра и действий по ссылке не обязательна (см. п. 4). |
| **Авторизованный пользователь** | Может создавать свои вишлисты, входить по email/паролю или OAuth. |

---

## 3. Функциональные требования

### 3.1. Вишлисты

- Пользователь создаёт вишлист с названием и опционально с поводом/датой (день рождения, Новый год и т.д.).
- У одного пользователя может быть несколько вишлистов.
- Вишлист имеет **публичную ссылку** (уникальный slug или id), по которой любой может открыть список без авторизации.
- Владелец может редактировать название, повод, дату и удалять вишлист.
- Владелец может копировать ссылку и делиться ею (отправка в мессенджеры, соцсети — на усмотрение реализации: кнопка «Поделиться» с копированием в буфер и/или нативным шарингом).

### 3.2. Товары (подарки) в вишлисте

- Каждый товар содержит:
  - **Название** (обязательно)
  - **Ссылка** (URL на магазин/товар)
  - **Цена** (число, валюта — единая для вишлиста или по умолчанию, например RUB)
  - **Картинка** (URL или загрузка; при наличии автозаполнения по ссылке — подтягивается автоматически)
- Владелец может добавлять, редактировать и удалять товары.
- Товар может быть:
  - **Обычным** — один человек резервирует целиком.
  - **Собирательным** — несколько человек могут вносить вклад до достижения целевой суммы (см. п. 3.5).

### 3.3. Просмотр вишлиста по ссылке (без регистрации)

- По публичной ссылке открывается страница вишлиста.
- Отображаются: название вишлиста, повод/дата (если заданы), список товаров с картинкой, названием, ценой, ссылкой.
- Для каждого товара видно:
  - Зарезервирован ли он (факт: да/нет), **без имени** того, кто зарезервировал.
  - Для собирательных — прогресс-бар (сколько собрано из целевой суммы), **без имён и сумм вкладчиков**.
- Гость может резервировать подарок и вносить вклад без регистрации (идентификация гостя — см. п. 4).

### 3.4. Резервация подарков

- Любой посетитель по ссылке (гость или авторизованный пользователь) может нажать «Зарезервировать» на незарезервированном обычном товаре.
- После резервации:
  - Остальные видят, что подарок зарезервирован (без имени).
  - Владелец вишлиста тоже видит только факт «зарезервировано», **не видит, кто зарезервировал**.
- Резервацию можно снять (тот же пользователь/гость), тогда подарок снова доступен для резервации.
- Обновление о резервации/снятии должно приходить **в реалтайме** всем, кто смотрит этот вишлист (WebSocket или аналог).

### 3.5. Скиды (вклады в подарок)

- Владелец при добавлении/редактировании товара может пометить его как **собирательный** и указать целевую сумму (или цена товара = целевая сумма по умолчанию).
- Гости/пользователи могут вносить вклад: указывают сумму (и при необходимости имя/подпись для получателя, без привязки к аккаунту у владельца).
- Отображается прогресс-бар: собрано X из Y (в валюте вишлиста).
- Владелец вишлиста **не видит**, кто сколько скинул (ни имена, ни суммы по людям).
- Все видят обновление прогресса **в реалтайме**.

**Продуктовые решения по скидам:**

- **Минимальный вклад:** рекомендуется задавать опционально на уровне вишлиста или товара (например, «мин. вклад 500 ₽»). Если не задано — минимальный вклад не ограничен (или технический минимум, например 1 единица валюты).
- **Если сумма не набралась к дате:** вишлист остаётся открытым; владелец может продлить срок или закрыть список. Собранные вклады не списываются автоматически — это лишь «обещания»; фактическая передача денег/подарка остаётся за пределами приложения (друзья договариваются сами). В интерфейсе можно показывать предупреждение: «До цели осталось X ₽» и кнопку «Напомнить друзьям» (шаринг ссылки).
- **Превышение целевой суммы:** либо запрещать вклады сверх цели, либо разрешать с предупреждением («Сумма уже набрана, вы уверены?»). Рекомендация: не принимать вклады выше остатка до цели.

### 3.6. Пустой вишлист

- Если в вишлисте ещё нет товаров, по публичной ссылке показывается заглушка: название вишлиста, текст вроде «Пока здесь ничего нет» / «Список пока пуст», опционально дата/повод. Кнопок «Резервировать» нет.
- Владелец в своём интерфейсе видит призыв добавить первый подарок и кнопку «Добавить подарок».

### 3.7. Реалтайм

- Все изменения, видимые гостям и владельцу:
  - резервация/снятие резервации;
  - новый вклад в собирательный подарок и обновление прогресса;
  - добавление/удаление/редактирование товаров владельцем (если владелец разрешил показ в реалтайме гостям).
- Должны отображаться **без перезагрузки страницы** (WebSocket, SSE или периодический опрос с коротким интервалом; приоритет — WebSocket/SSE).
- Реалтайм обязателен в рамках просмотра одной и той же публичной страницы вишлиста и, при необходимости, в личном кабинете владельца (обновление списка товаров после правок с другого устройства).

### 3.8. Авторизация

- **Минимум:** регистрация и вход по email + пароль.
- **Плюс:** OAuth (например, Google) для входа и регистрации.
- Пароль: надёжная политика (длина, сложность) и хранение в виде хеша (например, bcrypt). Восстановление пароля по email — желательно.

### 3.9. Публичная ссылка без регистрации

- Просмотр вишлиста по ссылке доступен **без регистрации и без входа**.
- Резервация и вклад по ссылке возможны без регистрации: идентификация гостя через анонимный id (например, сохранённый в localStorage или в cookie), привязанный к данной ссылке. Имена для подписей к вкладу — произвольный ввод (никнейм/имя), не привязанный к аккаунту. Владелец по-прежнему не видит, кто именно зарезервировал или скинул — только факты и прогресс.

### 3.10. Автозаполнение по ссылке (плюс)

- При добавлении товара владелец может вставить **URL товара** (магазин, маркетплейс).
- Приложение по возможности само подтягивает: **название**, **картинку**, **цену** (например, через мета-теги Open Graph, микроданные или парсинг страницы в рамках правил использования сайтов).
- Если что-то подтянуть не удалось — поля остаются пустыми, пользователь вводит вручную.
- Важно: соблюдать ограничения по запросам и правилам сайтов; при недоступности — показывать сообщение «Не удалось загрузить данные по ссылке».

---

## 4. Нефункциональные и технические требования

### 4.1. Стек

| Компонент | Требование |
|-----------|------------|
| Фронтенд | React или Next.js |
| Бэкенд | FastAPI (или другой удобный фреймворк) |
| База данных | PostgreSQL на сервере |
| Авторизация | Email + пароль (обязательно), OAuth (плюсом) |
| Публичная ссылка | Работает без регистрации |
| Адаптив | Под мобильные устройства |

### 4.2. Деплой и доступность

- Приложение должно быть **задеплоено** и доступно по URL.
- Проверяющий может зайти, зарегистрироваться и протестировать: создание вишлиста, добавление товаров, шаринг по ссылке, резервацию, скиды и реалтайм с двух устройств/браузеров.

### 4.3. Адаптивность

- Интерфейс корректно отображается и удобен на десктопе, планшете и смартфоне (адаптивная вёрстка, читаемые шрифты, кликабельные области).

### 4.4. Безопасность и конфиденциальность

- Владелец вишлиста **никогда** не видит привязку «кто зарезервировал» и «кто сколько внёс» — только агрегаты (зарезервировано/не зарезервировано, прогресс сбора).
- Публичная ссылка должна быть непредсказуемой (длинный случайный slug или UUID), чтобы нельзя было перебрать чужие списки.
- API защищён: авторизованные эндпоинты требуют токена; эндпоинты публичного просмотра/действий по ссылке работают по slug без раскрытия личных данных владельца.

---

## 5. Оглавление по приоритетам

| # | Блок | Обязательность |
|---|------|----------------|
| 1 | Вишлисты: создание, редактирование, публичная ссылка | Обязательно |
| 2 | Товары: название, ссылка, цена, картинка | Обязательно |
| 3 | Просмотр по ссылке без регистрации | Обязательно |
| 4 | Резервация подарков, анонимность для владельца | Обязательно |
| 5 | Скиды, прогресс-бар, анонимность для владельца | Обязательно |
| 6 | Реалтайм обновлений | Обязательно |
| 7 | Авторизация: email + пароль | Обязательно |
| 8 | Адаптив под мобильные | Обязательно |
| 9 | Деплой (фронт + бэк + БД) | Обязательно |
| 10 | OAuth (Google и др.) | Плюс |
| 11 | Автозаполнение по URL товара | Плюс |

---

## 6. Связь с документацией проекта

- **Тест-сценарии:** [docs/TEST_SCENARIOS.md](./TEST_SCENARIOS.md) и папка [docs/test-scenarios/](./test-scenarios/) — детальные сценарии по фичам (auth, wishlists, items, sharing, reservations, contributions, realtime, edge cases).
- **README:** [README.md](../README.md) — запуск, деплой, стек.

---

## 7. Что сейчас не реализовано

Ниже перечень требований из этого документа, по которым в коде есть пробелы (на момент актуализации).

### 7.1. Обязательные по PRD

| Требование | Статус | Где смотреть |
|------------|--------|----------------|
| **Повод/дата вишлиста** (опционально) | Нет в модели и API | В модели только `title`; нет полей `occasion`, `event_date`. Схемы и формы создания/редактирования вишлиста их не содержат. |
| **Реалтайм на странице владельца** | Нет | Публичная страница `/wishlists/s/:slug` подписана на WebSocket и обновляется при резервациях/вкладах. Страница управления `/wishlists/manage/:creatorSecret` не подписана на WS — владелец не видит изменения «на лету» без перезагрузки. |
| **Ограничение вкладов по целевой сумме** | Нет | В `contribute_item` не проверяется, что `total_contributed + amount` не превышает цену товара. Можно скидывать больше целевой суммы. По PRD: не принимать вклады выше остатка до цели. |
| **Пустой вишлист на публичной ссылке** | Нет явной заглушки | При `items.length === 0` показывается только заголовок и пустая сетка. Нет текста вида «Пока здесь ничего нет» / «Список пока пуст» (п. 3.6). |
| **Вишлисты, привязанные к пользователю** | Нет | Вишлисты создаются без `user_id`; «мои списки» берутся только из localStorage по `creator_secret`. При входе с другого устройства или браузера список созданных вишлистов пуст. По PRD: авторизованный пользователь создаёт вишлисты — ожидается привязка к аккаунту и API «мои вишлисты» по токену. |
| **Восстановление пароля** | Нет | Нет сброса пароля по email (в PRD отмечено как желательно). |

### 7.2. Плюс / улучшения

| Требование | Статус | Где смотреть |
|------------|--------|----------------|
| **Автозаполнение по URL товара** (п. 3.10) | Нет | Нет эндпоинта и UI: вставка ссылки на товар не подтягивает название, картинку и цену. |
| **Валюта вишлиста** | Нет | Нет поля «валюта» у вишлиста или товара; отображение суммы без символа валюты (например, RUB). |
| **Минимальный вклад** (опционально) | Да | Поле `min_contribution` у товара (управление списком), проверка при скидывании на бэкенде и валидация/подсказка на публичной странице. |
| **Нативный шаринг** | Да | Кнопка «Поделиться» вызывает `navigator.share()` (Web Share API), когда доступна; иначе только копирование ссылки. |

### 7.3. Уже реализовано (для полноты)

- Создание/редактирование/удаление вишлиста по `creator_secret`; публичная ссылка по `slug`.
- Товары: название, ссылка, цена, картинка; добавление/редактирование/удаление владельцем.
- Публичный просмотр по ссылке без регистрации; резервация и вклад по имени (гость не привязан к аккаунту).
- Владелец видит только факт «зарезервировано» и общую сумму вкладов (без имён).
- WebSocket для публичной страницы: резервации и вклады обновляются в реалтайме у гостей.
- Авторизация: email + пароль, Google OAuth; хранение пароля в виде хеша (bcrypt).
- Копирование ссылки для шаринга; страницы «моя резервация» и «мой вклад» по секрету.
- Адаптивная вёрстка; деплой (Vercel + бэкенд/БД по README).

Итог: обязательные пробелы — привязка вишлистов к пользователю, реалтайм на странице владельца, ограничение суммы вкладов по цене, повод/дата вишлиста, заглушка для пустого списка на публичной странице, при желании — восстановление пароля. Плюсом — автозаполнение по URL, валюта, минимальный вклад, нативный шаринг.

Этот файл (**PRODUCT_REQUIREMENTS.md**) является единым источником продуктовых и базовых технических требований к социальному вишлисту.
