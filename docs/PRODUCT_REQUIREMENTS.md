# Требования к продукту: Социальный вишлист

Документ описывает функциональные и технические требования к приложению вишлистов с шарингом, резервацией подарков и сборами на дорогие подарки.

---

## 1. Визия продукта

**Суть:** Пользователь создаёт списки желаний (день рождения, Новый год, свадьба и т.д.), добавляет товары с названием, ссылкой, ценой и картинкой. Делится списком с друзьями по ссылке. Друзья видят вишлист и могут зарезервировать подарок, чтобы не повторяться. Создатель списка **не видит**, кто что зарезервировал — сюрприз сохраняется.

Если подарок дорогой, несколько друзей могут скинуться. Каждый отмечает свой вклад, прогресс-бар показывает, сколько собрано. Владелец вишлиста **не видит**, кто сколько скинул.

Изменения (резервация, вклад) отображаются у всех **мгновенно**, без перезагрузки страницы. Реалтайм обязателен.

---

## 2. Роли и сценарии

| Роль | Описание |
|------|----------|
| **Владелец вишлиста** | Создал список, добавляет/редактирует товары, делится ссылкой. Не видит резервации и вклады по именам. |
| **Гость по ссылке** | Открыл публичную ссылку. Может просматривать вишлист, резервировать подарки и вносить вклады. Регистрация для просмотра и действий по ссылке не обязательна (см. п. 4). |
| **Авторизованный пользователь** | Может создавать свои вишлисты, входить по email/паролю или OAuth. |

---

## 3. Функциональные требования

### 3.1. Вишлисты

- Пользователь создаёт вишлист с названием и опционально с поводом/датой (день рождения, Новый год и т.д.).
- У одного пользователя может быть несколько вишлистов.
- Вишлист имеет **публичную ссылку** (уникальный slug или id), по которой любой может открыть список без авторизации.
- Владелец может редактировать название, повод, дату и удалять вишлист.
- Владелец может копировать ссылку и делиться ею (отправка в мессенджеры, соцсети — на усмотрение реализации: кнопка «Поделиться» с копированием в буфер и/или нативным шарингом).

### 3.2. Товары (подарки) в вишлисте

- Каждый товар содержит:
  - **Название** (обязательно)
  - **Ссылка** (URL на магазин/товар)
  - **Цена** (число, валюта — единая для вишлиста или по умолчанию, например RUB)
  - **Картинка** (URL или загрузка; при наличии автозаполнения по ссылке — подтягивается автоматически)
- Владелец может добавлять, редактировать и удалять товары.
- Товар может быть:
  - **Обычным** — один человек резервирует целиком.
  - **Собирательным** — несколько человек могут вносить вклад до достижения целевой суммы (см. п. 3.5).

### 3.3. Просмотр вишлиста по ссылке (без регистрации)

- По публичной ссылке открывается страница вишлиста.
- Отображаются: название вишлиста, повод/дата (если заданы), список товаров с картинкой, названием, ценой, ссылкой.
- Для каждого товара видно:
  - Зарезервирован ли он (факт: да/нет), **без имени** того, кто зарезервировал.
  - Для собирательных — прогресс-бар (сколько собрано из целевой суммы), **без имён и сумм вкладчиков**.
- Гость может резервировать подарок и вносить вклад без регистрации (идентификация гостя — см. п. 4).

### 3.4. Резервация подарков

- Любой посетитель по ссылке (гость или авторизованный пользователь) может нажать «Зарезервировать» на незарезервированном обычном товаре.
- После резервации:
  - Остальные видят, что подарок зарезервирован (без имени).
  - Владелец вишлиста тоже видит только факт «зарезервировано», **не видит, кто зарезервировал**.
- Резервацию можно снять (тот же пользователь/гость), тогда подарок снова доступен для резервации.
- Обновление о резервации/снятии должно приходить **в реалтайме** всем, кто смотрит этот вишлист (WebSocket или аналог).

### 3.5. Скиды (вклады в подарок)

- Владелец при добавлении/редактировании товара может пометить его как **собирательный** и указать целевую сумму (или цена товара = целевая сумма по умолчанию).
- Гости/пользователи могут вносить вклад: указывают сумму (и при необходимости имя/подпись для получателя, без привязки к аккаунту у владельца).
- Отображается прогресс-бар: собрано X из Y (в валюте вишлиста).
- Владелец вишлиста **не видит**, кто сколько скинул (ни имена, ни суммы по людям).
- Все видят обновление прогресса **в реалтайме**.

**Продуктовые решения по скидам:**

- **Минимальный вклад:** рекомендуется задавать опционально на уровне вишлиста или товара (например, «мин. вклад 500 ₽»). Если не задано — минимальный вклад не ограничен (или технический минимум, например 1 единица валюты).
- **Если сумма не набралась к дате:** вишлист остаётся открытым; владелец может продлить срок или закрыть список. Собранные вклады не списываются автоматически — это лишь «обещания»; фактическая передача денег/подарка остаётся за пределами приложения (друзья договариваются сами). В интерфейсе можно показывать предупреждение: «До цели осталось X ₽» и кнопку «Напомнить друзьям» (шаринг ссылки).
- **Превышение целевой суммы:** либо запрещать вклады сверх цели, либо разрешать с предупреждением («Сумма уже набрана, вы уверены?»). Рекомендация: не принимать вклады выше остатка до цели.
- **Удаление товара, по которому уже есть вклады:** владелец может удалить товар в любой момент. При удалении товара все вклады по нему удаляются из приложения (ссылка «Мой вклад» перестаёт работать — вкладчик видит сообщение «Вклад не найден или подарок был удалён»). Деньги приложение не хранит и не переводит; возврат или переназначение сбора остаётся за пределами приложения — организатор и вкладчики договариваются сами (например, по ссылке вишлиста или в мессенджере). Рекомендуется: при удалении товара с ненулевой суммой вкладов показывать владельцу предупреждение («У этого подарка есть вклады. После удаления вкладчики не смогут открыть страницу вклада. Удалить?»), а вкладчику по битой ссылке — понятный текст с предложением связаться с организатором.

### 3.6. Пустой вишлист

- Если в вишлисте ещё нет товаров, по публичной ссылке показывается заглушка: название вишлиста, текст вроде «Пока здесь ничего нет» / «Список пока пуст», опционально дата/повод. Кнопок «Резервировать» нет.
- Владелец в своём интерфейсе видит призыв добавить первый подарок и кнопку «Добавить подарок».

### 3.7. Реалтайм

- Все изменения, видимые гостям и владельцу:
  - резервация/снятие резервации;
  - новый вклад в собирательный подарок и обновление прогресса;
  - добавление/удаление/редактирование товаров владельцем (если владелец разрешил показ в реалтайме гостям).
- Должны отображаться **без перезагрузки страницы** (WebSocket, SSE или периодический опрос с коротким интервалом; приоритет — WebSocket/SSE).
- Реалтайм обязателен в рамках просмотра одной и той же публичной страницы вишлиста и, при необходимости, в личном кабинете владельца (обновление списка товаров после правок с другого устройства).

### 3.8. Авторизация

- **Минимум:** регистрация и вход по email + пароль.
- **Плюс:** OAuth (например, Google) для входа и регистрации.
- Пароль: надёжная политика (длина, сложность) и хранение в виде хеша (например, bcrypt). Восстановление пароля по email — желательно.

### 3.9. Публичная ссылка без регистрации

- Просмотр вишлиста по ссылке доступен **без регистрации и без входа**.
- Резервация и вклад по ссылке возможны без регистрации: идентификация гостя через анонимный id (например, сохранённый в localStorage или в cookie), привязанный к данной ссылке. Имена для подписей к вкладу — произвольный ввод (никнейм/имя), не привязанный к аккаунту. Владелец по-прежнему не видит, кто именно зарезервировал или скинул — только факты и прогресс.

### 3.10. Автозаполнение по ссылке (плюс)

- При добавлении товара владелец может вставить **URL товара** (магазин, маркетплейс).
- Приложение по возможности само подтягивает: **название**, **картинку**, **цену** (например, через мета-теги Open Graph, микроданные или парсинг страницы в рамках правил использования сайтов).
- Если что-то подтянуть не удалось — поля остаются пустыми, пользователь вводит вручную.
- Важно: соблюдать ограничения по запросам и правилам сайтов; при недоступности — показывать сообщение «Не удалось загрузить данные по ссылке».

---

## 4. Нефункциональные и технические требования

### 4.1. Стек

| Компонент | Требование |
|-----------|------------|
| Фронтенд | React или Next.js |
| Бэкенд | FastAPI (или другой удобный фреймворк) |
| База данных | PostgreSQL на сервере |
| Авторизация | Email + пароль (обязательно), OAuth (плюсом) |
| Публичная ссылка | Работает без регистрации |
| Адаптив | Под мобильные устройства |

### 4.2. Деплой и доступность

- Приложение должно быть **задеплоено** и доступно по URL.
- Проверяющий может зайти, зарегистрироваться и протестировать: создание вишлиста, добавление товаров, шаринг по ссылке, резервацию, скиды и реалтайм с двух устройств/браузеров.

### 4.3. Адаптивность

- Интерфейс корректно отображается и удобен на десктопе, планшете и смартфоне (адаптивная вёрстка, читаемые шрифты, кликабельные области).

### 4.4. Безопасность и конфиденциальность

- Владелец вишлиста **никогда** не видит привязку «кто зарезервировал» и «кто сколько внёс» — только агрегаты (зарезервировано/не зарезервировано, прогресс сбора).
- Публичная ссылка должна быть непредсказуемой (длинный случайный slug или UUID), чтобы нельзя было перебрать чужие списки.
- API защищён: авторизованные эндпоинты требуют токена; эндпоинты публичного просмотра/действий по ссылке работают по slug без раскрытия личных данных владельца.

---

## 5. Оглавление по приоритетам

| # | Блок | Обязательность |
|---|------|----------------|
| 1 | Вишлисты: создание, редактирование, публичная ссылка | Обязательно |
| 2 | Товары: название, ссылка, цена, картинка | Обязательно |
| 3 | Просмотр по ссылке без регистрации | Обязательно |
| 4 | Резервация подарков, анонимность для владельца | Обязательно |
| 5 | Скиды, прогресс-бар, анонимность для владельца | Обязательно |
| 6 | Реалтайм обновлений | Обязательно |
| 7 | Авторизация: email + пароль | Обязательно |
| 8 | Адаптив под мобильные | Обязательно |
| 9 | Деплой (фронт + бэк + БД) | Обязательно |
| 10 | OAuth (Google и др.) | Плюс |
| 11 | Автозаполнение по URL товара | Плюс |

---

## 6. Связь с документацией проекта

- **Тест-сценарии:** [docs/TEST_SCENARIOS.md](./TEST_SCENARIOS.md) и папка [docs/test-scenarios/](./test-scenarios/) — детальные сценарии по фичам (auth, wishlists, items, sharing, reservations, contributions, realtime, edge cases).
- **README:** [README.md](../README.md) — запуск, деплой, стек.

---

## 7. Анализ реализации (актуальное состояние)

Ниже — что уже сделано и что ещё не закрыто по требованиям этого документа.

### 7.1. Обязательные по PRD — реализовано

| Требование | Статус | Реализация |
|------------|--------|------------|
| **Повод/дата вишлиста** (опционально) | ✅ | Модель: `occasion`, `event_date`. API: создание/обновление/ответы. Фронт: форма создания (occasion, event_date), управление списком (title, occasion, event_date, currency), публичная страница и дашборд показывают повод/дату. |
| **Ограничение вкладов по целевой сумме** | ✅ | В `contribute_item`: проверка `total_contributed + amount <= price`; при превышении — 400 с текстом про остаток. |
| **Пустой вишлист на публичной ссылке** | ✅ | При `items.length === 0` показывается заглушка с текстом `wishlist.emptyPublic` («Пока здесь ничего нет» / «Список пока пуст»). |
| **Вишлисты, привязанные к пользователю** | ✅ | Модель: `Wishlist.user_id` (FK на User). Создание с `get_current_user_optional` — при авторизации вишлист привязывается к пользователю. API: `GET /wishlists/mine` (по токену) — список вишлистов пользователя. Дашборд запрашивает `/wishlists/mine`, создание вишлиста под защитой RequireAuth, токен уходит в запросах (auth-init). |
| **Валюта вишлиста** | ✅ | Модель: `Wishlist.currency` (по умолчанию RUB). Схемы и API: создание/обновление/публичный и управляющий ответы. Фронт: выбор валюты в управлении списком, отображение на публичной странице (цена и прогресс сбора в валюте). |
| **Минимальный вклад** (опционально) | ✅ | Модель: `WishlistItem.min_contribution`. API: при вкладе проверка `amount >= min_contribution`; в ответах товара. Фронт: поле в форме товара (управление), подсказка/валидация на публичной странице. |
| **Нативный шаринг** | ✅ | В управлении списком: при наличии `navigator.share` — кнопка «Поделиться» с Web Share API; иначе копирование ссылки. |

### 7.2. Обязательные по PRD — ещё не реализовано

| Требование | Статус | Где смотреть |
|------------|--------|----------------|
| **Реалтайм на странице владельца** | ❌ | Публичная страница `/wishlists/s/:slug` подписана на WebSocket — гости видят резервации/вклады в реалтайме. Страница управления `/wishlists/manage/:creatorSecret` не подключается к WS — владелец видит изменения только после перезагрузки. |
| **Восстановление пароля** | ❌ | В модели User есть `password_reset_token` и `password_reset_expires`, миграции/init_db создают колонки. Эндпоинтов «запросить сброс» (forgot) и «сбросить по токену» (reset) в auth API нет (в PRD отмечено как желательно). |

### 7.3. Плюс / улучшения — не реализовано

| Требование | Статус | Где смотреть |
|------------|--------|----------------|
| **Автозаполнение по URL товара** (п. 3.10) | ✅ | Эндпоинт `POST /api/wishlists/fetch-product`; кнопка «Заполнить по ссылке» в форме товара (Open Graph + schema.org). |

### 7.4. Уже реализовано (сводка)

- Вишлисты: создание (с поводом, датой, валютой), редактирование, удаление; публичная ссылка по `slug`; управление по `creator_secret`; привязка к пользователю и «мои вишлисты» по токену.
- Товары: название, ссылка, цена, картинка, минимальный вклад; добавление/редактирование/удаление владельцем.
- Публичный просмотр по ссылке без регистрации; отображение повода, даты, валюты; заглушка для пустого списка.
- Резервация и вклад по имени (гость без регистрации); владелец видит только факт «зарезервировано» и общую сумму вкладов (без имён).
- Ограничение вкладов: не больше цены товара; проверка минимального вклада.
- WebSocket: реалтайм на публичной странице (резервации и вклады).
- Авторизация: email + пароль, Google OAuth; хранение пароля в виде хеша (bcrypt).
- Шаринг: копирование ссылки + нативный шаринг (navigator.share), страницы «моя резервация» и «мой вклад» по секрету.
- Адаптивная вёрстка; деплой (Vercel + бэкенд/БД по README).

**Итог:** Обязательные пробелы — только **реалтайм на странице владельца** (WebSocket на `/wishlists/manage/...`) и при желании **восстановление пароля**. Плюсом остаётся **автозаполнение по URL товара**.

Этот файл (**PRODUCT_REQUIREMENTS.md**) является единым источником продуктовых и базовых технических требований к социальному вишлисту.
