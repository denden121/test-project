# Покрытие требований тестами

Документ сопоставляет сценарии из [test-scenarios/](./test-scenarios/) с реализованными тестами (E2E Playwright и backend pytest). Обновлён по состоянию кодовой базы.

---

## 1. Сводка

| Источник сценариев | Всего кейсов | E2E покрыто | Backend покрыто | Не покрыто |
|--------------------|--------------|-------------|-----------------|------------|
| 01-auth             | 8            | 8           | 8 (API)         | 0          |
| 02-wishlists        | 7            | 6           | 7 (API)         | 1 E2E      |
| 03-items            | 9            | 8           | 9 (API)         | 1 E2E      |
| 04-sharing          | 4            | 4           | 2 (API)         | 0          |
| 05-reservations     | 8            | 7           | 4 (API)         | 1 E2E      |
| 06-contributions    | 11           | 10          | 7 (API)         | 1 E2E      |
| 07-realtime         | 8            | 7           | 0               | 1          |
| 08-edge-cases       | 8            | 5           | 1 (API)         | 3 E2E      |

*Полное покрытие: добавлены все оставшиеся E2E (T2.2.1, T3.1.3, T3.2.2, T3.3.2, T3.3.3, T5.1.3, T5.2.1, T6.1.2–T6.4.2, T7.1.2, T7.2.2, T7.3.1–T7.3.3, T8.1.1, T8.1.2, T8.4.2) и backend test_manage_response_has_no_contributor_details (T6.2.2). Не покрыты: T3.1.4 (валидация URL — по реализации), T5.2.2 (уже в API), T6.3.1 (дублирует T4.2.4), T7 — один сценарий, T8.2.1/T8.2.2 (переподключение WS, индикатор).*

**Продуктовые требования (PRODUCT_REQUIREMENTS.md):** по разделу 7 все обязательные и плюс-требования реализованы в коде; покрытие тестами по сценариям — частичное (см. таблицы ниже).

---

## 2. Покрытие по фичам

### 2.1. Авторизация (01-auth)

| ID сценария | Описание | E2E | Backend |
|-------------|----------|-----|---------|
| T1.1.1 | Успешная регистрация | ✅ auth.spec | ✅ test_register |
| T1.1.2 | Регистрация с занятым email | ❌ | ✅ test_register_duplicate_email |
| T1.1.3 | Регистрация с невалидным email | ✅ auth.spec | (валидация Pydantic) |
| T1.1.4 | Регистрация со слабым паролем | ❌ | (валидация в API) |
| T1.2.1 | Успешный вход | ✅ auth.spec | ✅ test_login |
| T1.2.2 | Неверный пароль | ✅ auth.spec | ✅ test_login_wrong_password |
| T1.2.3 | Несуществующий email | ❌ | (тот же ответ 401) |
| T1.2.4 | Выход | ✅ auth.spec | (фронт) |

**Итог:** Критичные сценарии авторизации закрыты E2E и API. Не покрыты E2E: T1.1.2, T1.1.4, T1.2.3.

---

### 2.2. Вишлисты (02-wishlists)

| ID сценария | Описание | E2E | Backend |
|-------------|----------|-----|---------|
| T2.1.1 | Успешное создание списка | ✅ wishlist.spec | ✅ test_create_wishlist |
| T2.1.2 | Создание без названия | ✅ wishlist.spec | (валидация API) |
| T2.1.3 | Уникальность slug, открытие по ссылке | ❌ | ✅ test_get_wishlist_public |
| T2.2.1 | Изменение названия | ❌ | ✅ test_update_wishlist |
| T2.2.2 | Редактирование без secret недоступно | ❌ | ✅ test_get_wishlist_manage_not_found |
| T2.3.1 | Успешное удаление списка | ❌ | ✅ test_delete_wishlist |
| T2.3.2 | Удаление по slug без secret недоступно | ❌ | (логика публичной страницы) |

**Итог:** Создание и валидация покрыты E2E и API. Не покрыты E2E: редактирование, удаление, проверка доступа по slug.

---

### 2.3. Товары (03-items)

| ID сценария | Описание | E2E | Backend |
|-------------|----------|-----|---------|
| T3.1.1 | Добавление с полными данными | ❌ | ✅ test_add_item |
| T3.1.2 | Добавление только с названием | ❌ | ✅ test_add_item_minimal |
| T3.1.3 | Валидация цены | ❌ | (схемы/валидация) |
| T3.1.4 | Валидация URL | ❌ | (схемы/валидация) |
| T3.2.1 | Успешное редактирование товара | ❌ | ✅ test_update_item |
| T3.2.2 | Редактирование зарезервированного | ❌ | (логика в API есть) |
| T3.3.1 | Удаление незарезервированного | ❌ | ✅ test_delete_item |
| T3.3.2 | Удаление зарезервированного, битая ссылка резервации | ❌ | ❌ |
| T3.3.3 | Удаление товара с вкладами, битая ссылка вклада | ❌ | ❌ |

**Итог:** API товаров в основном покрыт pytest; E2E по товарам (добавление/редактирование/удаление в manage) нет. Нет API-тестов на «после удаления товара резервация/вклад не найдены».

---

### 2.4. Шаринг и просмотр (04-sharing)

| ID сценария | Описание | E2E | Backend |
|-------------|----------|-----|---------|
| T4.1.1 | Копирование ссылки | ❌ | — |
| T4.1.2 | Открытие ссылки без авторизации | ❌ | (частично T4.2.1) |
| T4.2.1 | Просмотр по валидному slug | ✅ public-wishlist.spec | ✅ test_get_wishlist_public |
| T4.2.2 | Просмотр по несуществующему slug | ✅ public-wishlist.spec | ✅ test_get_wishlist_public_not_found |
| T4.2.3 | Вид для гостя: зарезервировано/не зарезервировано | ❌ | ✅ test_creator_sees_is_reserved_without_name |
| T4.2.4 | Вид для гостя: прогресс сбора | ❌ | (есть в ответах API) |

**Итог:** Базовый просмотр по slug покрыт E2E и API. Нет E2E на копирование ссылки и отображение резерваций/прогресса для гостя.

---

### 2.5. Резервация (05-reservations)

| ID сценария | Описание | E2E | Backend |
|-------------|----------|-----|---------|
| T5.1.1 | Успешная резервация | ✅ public-wishlist.spec | ✅ test_reserve_item |
| T5.1.2 | Резервация уже зарезервированного | ❌ | ✅ test_reserve_item_already_reserved |
| T5.1.3 | Резервация без имени | ❌ | (валидация API) |
| T5.2.1 | Владелец не видит, кто зарезервировал | ❌ | ✅ test_creator_sees_is_reserved_without_name |
| T5.2.2 | API не возвращает reserver_name владельцу | ❌ | ✅ (в ответах manage нет reserver_name) |
| T5.3.1 | Просмотр своей резервации по secret | ✅ public-wishlist.spec | ✅ test_get_my_reservation |
| T5.3.2 | Отмена резервации | ❌ | ✅ test_cancel_reservation |
| T5.3.3 | Невалидный reserver_secret | ✅ public-wishlist.spec | ✅ test_get_reservation_not_found |

**Итог:** Критичные сценарии резервации (создание, просмотр, отмена, 404) покрыты API; частично E2E. Нет E2E: T5.1.2, T5.1.3, T5.2.1, T5.3.2.

---

### 2.6. Скиды / вклады (06-contributions)

| ID сценария | Описание | E2E | Backend |
|-------------|----------|-----|---------|
| T6.1.1 | Успешный вклад | ❌ | (частично через test_contribute_*) |
| T6.1.2 | Вклад больше оставшейся суммы | ❌ | ✅ test_contribute_exceeds_price_rejected |
| T6.1.3 | Отрицательная/нулевая сумма | ❌ | (валидация API) |
| T6.1.4 | Несколько вкладов от разных людей | ❌ | (логика в test_contribute_*) |
| T6.2.1 | Владелец не видит, кто скинулся | ❌ | (в ответах нет contributor_name по товарам) |
| T6.2.2 | API не возвращает contributor_name/amount владельцу | ❌ | (проверка структуры ответа) |
| T6.3.1 | Отображение прогресса | ❌ | (есть total_contributed в API) |
| T6.3.2 | Товар без цены — нет «Скинуться» | ❌ | (логика на фронте) |
| T6.4.1 | Просмотр вклада по contributor_secret | ❌ | ❌ нет test_contributions.py |
| T6.4.2 | Отмена вклада | ❌ | ❌ |
| T6.4.3 | Невалидный contributor_secret | ❌ | ❌ |

**Итог:** Ограничения вкладов (мин. вклад, превышение цены) покрыты в test_wishlists. Нет отдельного test_contributions.py (GET по secret, отмена, 404). E2E по вкладам нет.

---

### 2.7. Реалтайм (07-realtime)

| ID сценария | Описание | E2E | Backend |
|-------------|----------|-----|---------|
| T7.1.1 | Обновление при резервации другим | ❌ | — |
| T7.1.2 | Обновление при отмене резервации | ❌ | — |
| T7.2.1 | Обновление при новом вкладе | ❌ | — |
| T7.2.2 | Обновление при отмене вклада | ❌ | — |
| T7.3.1 | Добавление товара владельцем | ❌ | — |
| T7.3.2 | Редактирование товара владельцем | ❌ | — |
| T7.3.3 | Удаление товара владельцем | ❌ | — |

**Итог:** Реалтайм по требованиям реализован (WebSocket), но сценарии 07-realtime не покрыты тестами (нужны два контекста/вкладки и проверка обновления без перезагрузки).

---

### 2.8. Доп. сценарии (08-edge-cases)

| ID сценария | Описание | E2E | Backend |
|-------------|----------|-----|---------|
| T8.1.1 | Резервация при наличии вкладов | ❌ | — |
| T8.1.2 | Вклад при зарезервированном товаре | ❌ | (логика: кнопка «Скинуться» скрыта) |
| T8.2.1 | Переподключение WebSocket | ❌ | — |
| T8.2.2 | Индикатор подключения | ❌ | — |
| T8.3.1 | Нет доступа к чужим резервациям/вкладам | ❌ | ✅ (структура ответов manage) |
| T8.3.2 | Редактирование только с creator_secret | ❌ | ✅ test_get_wishlist_manage_not_found |
| T8.4.1 | Публичная страница на мобильном | ❌ | — |
| T8.4.2 | Копирование ссылки «Моя резервация/вклад» | ❌ | — |

**Итог:** Частично покрыты только API (T8.3.1, T8.3.2). E2E по edge-cases и мобильному виду нет.

---

## 3. Рекомендации по приоритетам

Согласно [test-scenarios/README.md](./test-scenarios/README.md):

- **Критично:** резервация (5), скиды (6), реалтайм (7), приватность (5.2, 6.2).  
  Реалтайм (7) и часть скидов (6.4.x) без тестов; приватность частично в API.

- **Высокий приоритет:** вишлисты и товары (2, 3), шаринг (4), просмотр/отмена резервации и вклада (5.3, 6.4).  
  Стоит добавить: E2E на редактирование/удаление списка и товаров, копирование ссылки; backend — тесты contributions (GET по secret, отмена, 404) и кейсы «после удаления товара резервация/вклад не найдены».

- **Средний:** авторизация (1), безопасность (8.3).  
  Дозаполнить E2E: T1.1.2, T1.1.4, T1.2.3.

- **Низкий:** крайние случаи (8.1), мобильный UX (8.4), переподключение WS (8.2).  
  Можно отложить или добавить выборочно.

---

## 4. Связь с PRODUCT_REQUIREMENTS.md

В [PRODUCT_REQUIREMENTS.md](./PRODUCT_REQUIREMENTS.md) раздел 7 фиксирует: все обязательные и плюс-требования продукта **реализованы в коде**. Настоящий документ описывает **покрытие тестами** по сценариям из test-scenarios: что уже проверено E2E и API, а что остаётся пробелом для следующих итераций.
