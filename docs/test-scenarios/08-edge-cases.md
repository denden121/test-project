# 8. Дополнительные сценарии (крайние случаи и UX)

Формат для Playwright: шаги с селекторами и проверки. Локаль — `ru`.

---

## US-8.1 Один товар: и резервация, и вклады

### T8.1.1 Резервация при наличии вкладов

- **Роут:** `/wishlists/s/:slug`
- **Предусловия:** по товару уже есть вклады (создать через API).
- **Шаги:**
  1. `page.goto('/wishlists/s/' + slug)`
  2. У этого товара нажать «Зарезервировать подарок» (если кнопка доступна) и завершить резервацию.
- **Проверки:**
  - По ТЗ: либо резервация успешна (подарок «закреплён» за резервировавшим), либо показывается сообщение что резервировать нельзя; зафиксировать фактическое поведение в тесте (например `expect(page.getByText(/зарезервирован|нельзя|уже есть вклады/i)).toBeVisible()`).

---

### T8.1.2 Вклад при зарезервированном товаре

- **Роут:** `/wishlists/s/:slug`
- **Предусловия:** товар зарезервирован.
- **Шаги:**
  1. `page.goto('/wishlists/s/' + slug)`
- **Проверки:**
  - У зарезервированного товара кнопка «Скинуться» отсутствует или disabled → `expect(page.locator('button:has-text("Скинуться")').first()).toBeDisabled()` или не видна в карточке этого товара (проверка по контексту карточки).

---

## US-8.2 Поведение при потере связи

### T8.2.1 Переподключение WebSocket

- **Тип:** e2e с эмуляцией сети (Playwright `page.context().setOffline(true)` / `setOffline(false)`).
- **Предусловия:** публичная страница вишлиста открыта, WebSocket подключен.
- **Шаги:**
  1. `page.goto('/wishlists/s/' + slug)` и дождаться загрузки.
  2. Включить offline → `page.context().setOffline(true)`.
  3. Подождать 1–2 сек.
  4. Выключить offline → `page.context().setOffline(false)`.
  5. Имитировать изменение данных (в другом контексте резервация или вклад), подождать.
- **Проверки:**
  - После восстановления сети страница получает обновление (реалтайм снова работает) или показывается предложение обновить страницу; проверить видимость обновлённых данных или кнопки «Обновить» в течение таймаута.

---

### T8.2.2 Индикатор подключения (опционально)

- **Роут:** `/wishlists/s/:slug`
- **Шаги:**
  1. Открыть вишлист.
- **Проверки:**
  - Если в UI есть индикатор «онлайн» / «обновления в реальном времени» — он виден; при отключении сети — предупреждение или смена индикатора (по реализации).

---

## US-8.3 Безопасность и доступ

### T8.3.1 Нет доступа к чужим резервациям/вкладам

- **Тип:** API-тест (Playwright `request` или отдельный бэкенд-тест).
- **Шаги:** GET эндпоинта публичного вишлиста по slug (и при наличии — с creator_secret); GET manage.
- **Проверки:** В ответе по items нет полей `reserver_name`, `reserver_secret`, нет массива вкладов с `contributor_name` и персональными `amount`; владелец видит только `is_reserved` и `total_contributed`.

---

### T8.3.2 Редактирование только с creator_secret

- **Роут:** редактирование без secret — только публичная страница по slug.
- **Шаги:**
  1. Открыть только `/wishlists/s/' + slug` (не открывать manage).
  2. Попытаться перейти на `/wishlists/manage/random-secret` или проверить отсутствие формы добавления товара на публичной странице.
- **Проверки:**
  - На публичной странице нет кнопок «Добавить товар», «Удалить список», «Изменить» у товаров; при прямом переходе на manage с неверным secret — 404 или «Не найдено» → `expect(page.getByText(/не найден|not found/i)).toBeVisible()`.

---

## US-8.4 Мобильный и доступность

### T8.4.1 Публичная страница на мобильном

- **Роут:** `/wishlists/s/:slug`
- **Предусловия:** в конфиге Playwright задан viewport мобильного (например `{ width: 375, height: 667 })` или проект с `device: 'iPhone 13'`.
- **Шаги:**
  1. `page.setViewportSize({ width: 375, height: 667 })` (или через project).
  2. `page.goto('/wishlists/s/' + slug)`
- **Проверки:**
  - Страница читаема (заголовок и товары видимы); кнопки «Зарезервировать подарок» и «Скинуться» доступны (видимы и кликабельны) → `expect(page.getByRole('button', { name: 'Зарезервировать подарок' })).toBeVisible()` и `expect(page.getByRole('button', { name: 'Скинуться' })).toBeVisible()`.

---

### T8.4.2 Копирование ссылки «Моя резервация/вклад»

- **Роут:** после успешной резервации или вклада (страница с сообщением и ссылкой).
- **Предусловия:** только что выполнена резервация (T5.1.1) или вклад (T6.1.1).
- **Шаги:**
  1. На странице успеха найти ссылку на «Моя резервация» / «Мой вклад» (или кнопку «Копировать»).
  2. Скопировать URL (из атрибута `href` или через clipboard).
  3. Открыть скопированный URL в той же сессии или новой → `page.goto(copiedUrl)`.
- **Проверки:**
  - Открывается страница «Моя резервация» / «Мой вклад» с теми же данными (товар, имя) → `expect(page).toHaveURL(/\/reservations\/|\/contributions\//)` и видимость заголовка и данных.
