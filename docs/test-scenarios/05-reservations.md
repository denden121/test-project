# 5. Резервация подарков

Сценарии для Playwright: шаги с селекторами и проверки. Локаль — `ru`.

---

## US-5.1 Зарезервировать подарок

### T5.1.1 Успешная резервация

- **Роут:** `/wishlists/s/:slug`
- **Предусловия:** вишлист с минимум одним незарезервированным товаром (создать вишлист + товар через API или UI).
- **Шаги:**
  1. `page.goto('/wishlists/s/' + slug)`
  2. У первого незарезервированного товара нажать «Зарезервировать подарок» → `page.getByRole('button', { name: 'Зарезервировать подарок' }).first().click()`
  3. В модалке/форме ввести имя → поле с лейблом «Ваше имя» или placeholder «Например: Маша» → `page.getByPlaceholder(/Маша|Mary/).or(page.getByLabel(/Ваше имя|Your name/)).fill('Маша')`
  4. Подтвердить → `page.getByRole('button', { name: 'Зарезервировать' }).click()`
- **Проверки:**
  - Сообщение об успехе (например «Подарок зарезервирован!») → `expect(page.getByText(/зарезервирован|reserved/i)).toBeVisible()`
  - На странице отображается ссылка или кнопка «Сохранить ссылку»; в ответе/на странице есть URL вида `/reservations/...` (можно вытащить из ссылки для T5.3.1).
  - Товар помечен как зарезервированный (на этой же странице или после перезагрузки) → `expect(page.getByText('Зарезервировано')).toBeVisible()`

---

### T5.1.2 Резервация уже зарезервированного товара

- **Роут:** `/wishlists/s/:slug`
- **Предусловия:** у товара уже есть резервация (создать через API).
- **Шаги:**
  1. `page.goto('/wishlists/s/' + slug)`
- **Проверки:**
  - У этого товара нет кнопки «Зарезервировать подарок» или она disabled; отображается «Зарезервировано» → `expect(page.getByText('Зарезервировано')).toBeVisible()` и `expect(page.getByRole('button', { name: 'Зарезервировать подарок' })).toHaveCount(0)` (или только для других товаров).

---

### T5.1.3 Резервация без имени

- **Роут:** `/wishlists/s/:slug`
- **Предусловия:** вишлист с незарезервированным товаром.
- **Шаги:**
  1. `page.goto('/wishlists/s/' + slug)`
  2. Нажать «Зарезервировать подарок» у товара.
  3. Оставить поле имени пустым.
  4. Нажать «Зарезервировать» в форме.
- **Проверки:**
  - Валидация: сообщение «Обязательное поле» или форма не отправлена; товар остаётся незарезервированным.

---

## US-5.2 Владелец не видит, кто зарезервировал

### T5.2.1 Просмотр списка владельцем

- **Роут:** `/wishlists/manage/:creatorSecret` или `/wishlists/s/:slug` (от имени владельца — тот же контент по ТЗ).
- **Предусловия:** по списку есть резервации от друзей (создать через API от другого «лица»).
- **Шаги:**
  1. Владелец открывает страницу управления или публичную страницу.
  2. `page.goto('/wishlists/manage/' + creatorSecret)` (или публичную по slug).
- **Проверки:**
  - По товарам видно только «Зарезервировано»; на странице нет текста с именем резервировавшего (reserver_name) → `expect(page.getByText('Зарезервировано')).toBeVisible()` и `expect(page.getByText('Маша')).not.toBeVisible()` (если «Маша» — имя резервировавшего и оно нигде больше не выводится владельцу).

---

### T5.2.2 API не возвращает reserver_name владельцу

- **Тип:** API-тест (можно Playwright request или отдельный pytest).
- **Шаги:** GET публичного вишлиста по slug (с creator_secret в query/header если такой вариант есть) или GET manage-эндпоинта.
- **Проверки:** В теле ответа у items нет полей `reserver_name`, `reserver_secret`; есть только флаг `is_reserved`.

---

## US-5.3 Просмотр и отмена своей резервации

### T5.3.1 Просмотр своей резервации по secret

- **Роут:** `/reservations/:reserverSecret`
- **Предусловия:** резервация создана, сохранён `reserver_secret` (из ответа API или со страницы после T5.1.1).
- **Шаги:**
  1. `page.goto('/reservations/' + reserverSecret)`
- **Проверки:**
  - Заголовок «Моя резервация» или аналог → `expect(page.getByRole('heading', { name: /Моя резервация|My reservation/i })).toBeVisible()`
  - Отображаются название товара, дата резервации, введённое имя → `expect(page.getByText('Маша')).toBeVisible()` (или подставить имя из данных).

---

### T5.3.2 Отмена резервации

- **Роут:** `/reservations/:reserverSecret`
- **Предусловия:** есть своя резервация.
- **Шаги:**
  1. `page.goto('/reservations/' + reserverSecret)`
  2. `page.getByRole('button', { name: 'Отменить резервацию' }).click()`
  3. Подтвердить диалог → `page.on('dialog', d => d.accept())`
- **Проверки:**
  - Редирект или сообщение об отмене; при переходе на публичную страницу вишлиста товар снова доступен для резервации → открыть `/wishlists/s/{slug}` и `expect(page.getByRole('button', { name: 'Зарезервировать подарок' })).toBeVisible()` для этого товара.

---

### T5.3.3 Невалидный reserver_secret

- **Шаги:**
  1. `page.goto('/reservations/invalid-secret-xyz')`
- **Проверки:**
  - Сообщение «Резервация не найдена» или 404 → `expect(page.getByText(/не найдена|not found/i)).toBeVisible()` или проверка статуса/контента.
