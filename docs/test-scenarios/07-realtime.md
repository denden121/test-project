# 7. Реалтайм-обновления

Сценарии для Playwright: два контекста/браузера или две вкладки, WebSocket подключен к одному slug. Локаль — `ru`.

---

## US-7.1 Мгновенное отображение резервации

### T7.1.1 Обновление при резервации другим

- **Предусловия:** вишлист с минимум одним незарезервированным товаром; WebSocket включён в приложении для `/wishlists/s/:slug`.
- **Шаги:**
  1. **Контекст A:** открыть публичную страницу вишлиста и дождаться загрузки (и при необходимости установления WS) → `pageA.goto('/wishlists/s/' + slug)`, опционально дождаться видимости карточки товара.
  2. **Контекст B:** открыть ту же публичную страницу → `pageB.goto('/wishlists/s/' + slug)`.
  3. **Контекст B:** зарезервировать один из товаров (заполнить имя, нажать «Зарезервировать»).
  4. **Контекст A:** без перезагрузки страницы проверить обновление.
- **Проверки (в контексте A):**
  - Товар, зарезервированный в B, отображается как «Зарезервировано» без перезагрузки → `expect(pageA.getByText('Зарезервировано')).toBeVisible({ timeout: 10000 })` (с таймаутом на доставку WS).

---

### T7.1.2 Обновление при отмене резервации

- **Предусловия:** товар зарезервирован; в контексте A и B открыта публичная страница вишлиста.
- **Шаги:**
  1. **A:** `pageA.goto('/wishlists/s/' + slug)` и дождаться загрузки.
  2. **B:** `pageB.goto('/wishlists/s/' + slug)`.
  3. В одном из контекстов (или в третьем) открыть страницу «Моя резервация» по `reserver_secret` и отменить резервацию.
  4. В A и B проверить обновление без перезагрузки.
- **Проверки:**
  - В A и B у этого товара снова видна кнопка «Зарезервировать подарок» (или исчез текст «Зарезервировано») в течение нескольких секунд → `expect(pageA.getByRole('button', { name: 'Зарезервировать подарок' })).toBeVisible({ timeout: 10000 })`.

---

## US-7.2 Мгновенное отображение вкладов

### T7.2.1 Обновление при новом вкладе

- **Предусловия:** вишлист с товаром с ценой; в контексте A открыта публичная страница.
- **Шаги:**
  1. **A:** `pageA.goto('/wishlists/s/' + slug)`.
  2. **B:** `pageB.goto('/wishlists/s/' + slug)`, внести вклад по товару (имя, сумма), отправить форму.
  3. **A:** не перезагружать страницу.
- **Проверки (A):**
  - Прогресс-бар или текст «Собрано» обновился и показывает новую сумму → `expect(pageA.getByText(/Собрано \d+/)).toBeVisible({ timeout: 10000 })` или проверка увеличения числа (например через `pageA.getByText(/Собрано/).textContent()` до и после).

---

### T7.2.2 Обновление при отмене вклада

- **Предусловия:** по товару есть вклад; в A и B открыта публичная страница.
- **Шаги:**
  1. В другом контексте открыть `/contributions/:contributorSecret` и отменить вклад.
  2. В A и B проверить обновление без перезагрузки.
- **Проверки:**
  - Сумма/прогресс по товару уменьшились во всех открытых сессиях (проверка текста «Собрано» или значения прогресса).

---

## US-7.3 Реалтайм при изменении списка владельцем

### T7.3.1 Добавление товара владельцем

- **Предусловия:** вишлист создан; в контексте A открыта публичная страница как «друг».
- **Шаги:**
  1. **A:** `pageA.goto('/wishlists/s/' + slug)`.
  2. **B (владелец):** `pageB.goto('/wishlists/manage/' + creatorSecret)`, добавить новый товар (название «Новый товар»), сохранить.
  3. **A:** не перезагружать.
- **Проверки (A):**
  - На странице появился «Новый товар» без перезагрузки → `expect(pageA.getByText('Новый товар')).toBeVisible({ timeout: 10000 })`.

---

### T7.3.2 Редактирование товара владельцем

- **Предусловия:** в вишлисте есть товар; в A открыта публичная страница.
- **Шаги:**
  1. **A:** `pageA.goto('/wishlists/s/' + slug)`.
  2. **B:** на странице управления изменить название/цену товара и сохранить.
  3. **A:** не перезагружать.
- **Проверки (A):**
  - У товара отображаются обновлённые название/цена → `expect(pageA.getByText(updatedTitle)).toBeVisible({ timeout: 10000 })`.

---

### T7.3.3 Удаление товара владельцем

- **Предусловия:** в вишлисте есть товар (название известно); в A открыта публичная страница.
- **Шаги:**
  1. **A:** `pageA.goto('/wishlists/s/' + slug)`.
  2. **B:** на странице управления удалить этот товар (с подтверждением).
  3. **A:** не перезагружать.
- **Проверки (A):**
  - Товар исчез из списка → `expect(pageA.getByText(itemTitle)).not.toBeVisible()` или `toBeHidden({ timeout: 10000 })`.
